---
import siteDetails from '@/config/siteDetails';
import { formatPhoneTel } from '@/utils/phone';

// Type definitions
type PageType = 'general' | 'catholic' | 'veteran';
type Language = 'en' | 'es';

interface RouteMap {
  [key: string]: {
    en: string;
    es: string;
  };
}

// Detect current page type and language from URL
const pathname: string = Astro.url.pathname;
const isSpanish: boolean = pathname.includes('-es') || pathname === '/es';
const isCatholic: boolean = pathname.includes('catholic');
const isVeteran: boolean = pathname.includes('veteran');
const currentPageType: PageType = isVeteran ? 'veteran' : isCatholic ? 'catholic' : 'general';

// Determine base paths for navigation
const basePath: string = isSpanish ? '' : '';
const generalPath: string = isSpanish ? '/' : '/';
const catholicPath: string = isSpanish ? '/catholic-es' : '/catholic';
const veteranPath: string = isSpanish ? '/veteran-es' : '/veteran';

/**
 * Get alternate language URL for the current page
 * 
 * Maps the current page path to its equivalent in the alternate language.
 * Uses a predefined route map for known routes, with fallback logic for
 * unknown routes by adding/removing the '-es' suffix.
 * 
 * @returns The URL path for the alternate language version of the page
 */
function getAlternateLanguageUrl(): string {
  const routeMap: RouteMap = {
    '/': { en: '/', es: '/es' },
    '/es': { en: '/', es: '/es' },
    '/catholic': { en: '/catholic', es: '/catholic-es' },
    '/catholic-es': { en: '/catholic', es: '/catholic-es' },
    '/veteran': { en: '/veteran', es: '/veteran-es' },
    '/veteran-es': { en: '/veteran', es: '/veteran-es' },
    '/cremation': { en: '/cremation', es: '/cremation-es' },
    '/cremation-es': { en: '/cremation', es: '/cremation-es' },
    '/burial': { en: '/burial', es: '/burial-es' },
    '/burial-es': { en: '/burial', es: '/burial-es' },
    '/catholic-cremation': { en: '/catholic-cremation', es: '/catholic-cremation-es' },
    '/catholic-cremation-es': { en: '/catholic-cremation', es: '/catholic-cremation-es' },
    '/catholic-burial': { en: '/catholic-burial', es: '/catholic-burial-es' },
    '/catholic-burial-es': { en: '/catholic-burial', es: '/catholic-burial-es' },
    '/veteran-cremation': { en: '/veteran-cremation', es: '/veteran-cremation-es' },
    '/veteran-cremation-es': { en: '/veteran-cremation', es: '/veteran-cremation-es' },
    '/veteran-burial': { en: '/veteran-burial', es: '/veteran-burial-es' },
    '/veteran-burial-es': { en: '/veteran-burial', es: '/veteran-burial-es' },
  };
  
  if (routeMap[pathname]) {
    return isSpanish ? routeMap[pathname].en : routeMap[pathname].es;
  }
  
  // Fallback: try to convert by adding/removing -es suffix
  if (isSpanish) {
    return pathname.replace(/-es$/, '');
  } else {
    return `${pathname}-es`;
  }
}

const alternateLanguageUrl: string = getAlternateLanguageUrl();
const alternateLanguageLabel: string = isSpanish ? 'EN' : 'ES';
const callNowButtonText: string = isSpanish ? 'Llame Ahora' : 'Call Now';

/**
 * Determine company name based on page type and language
 * 
 * Returns the appropriate company name based on whether the current page
 * is for general, Catholic, or Veteran services, and the current language.
 * 
 * @returns The localized company name string
 */
function getCompanyName(): string {
  if (isVeteran) {
    return isSpanish ? 'Cuidado de Veteranos' : 'Veteran Care';
  } else if (isCatholic) {
    return isSpanish ? 'Cuidado Católico' : 'Catholic Care';
  } else {
    return isSpanish ? 'Cuidado Asequible' : 'Affordable Care';
  }
}

const displayCompanyName: string = getCompanyName();
---

<nav class="sticky top-0 z-50 bg-primary text-white shadow-lg overflow-x-hidden">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-full">
    <!-- Unified Navigation Bar -->
    <div class="flex items-center justify-between gap-2 md:gap-4 h-14 md:h-16 min-w-0">
      <!-- Left Side: Hamburger Menu (Mobile) + Page Type Navigation (Desktop) -->
      <div class="flex items-center gap-1 md:gap-2 min-w-0">
        <!-- Hamburger Menu Button (Mobile Only) -->
        <button
          id="mobile-menu-toggle"
          aria-label={isSpanish ? "Abrir menú de navegación" : "Open navigation menu"}
          aria-expanded="false"
          aria-controls="mobile-menu"
          class="md:hidden bg-white/10 hover:bg-white/20 text-white p-3 rounded-md transition-all duration-200 border border-white/30 hover:border-white/50 flex items-center justify-center min-w-[44px] min-h-[44px]"
          title={isSpanish ? "Menú" : "Menu"}
        >
          <svg id="hamburger-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        
        <!-- Desktop Navigation Links -->
        <div class="hidden md:flex items-center gap-1 md:gap-2 min-w-0" role="navigation" aria-label={isSpanish ? "Navegación principal" : "Main navigation"}>
        <a
          href={generalPath}
          aria-label={isSpanish ? "Inicio" : "Home"}
          aria-current={currentPageType === 'general' ? 'page' : undefined}
          class={`page-link nav-link px-2 sm:px-3 md:px-4 lg:px-6 py-2 md:py-3 font-semibold text-xs sm:text-sm md:text-base transition-all duration-200 whitespace-nowrap relative min-h-[44px] flex items-center ${
            currentPageType === 'general'
              ? 'bg-accent text-white border-b-2 border-white'
              : 'text-white/80 hover:text-white hover:bg-primary-light/20'
          }`}
        >
          {isSpanish ? 'Inicio' : 'Home'}
        </a>
        <a
          href={catholicPath}
          aria-label={isSpanish ? "Católico" : "Catholic"}
          aria-current={currentPageType === 'catholic' ? 'page' : undefined}
          class={`page-link nav-link px-2 sm:px-3 md:px-4 lg:px-6 py-2 md:py-3 font-semibold text-xs sm:text-sm md:text-base transition-all duration-200 whitespace-nowrap relative min-h-[44px] flex items-center ${
            currentPageType === 'catholic'
              ? 'bg-accent text-white border-b-2 border-white'
              : 'text-white/80 hover:text-white hover:bg-primary-light/20'
          }`}
        >
          {isSpanish ? 'Católico' : 'Catholic'}
        </a>
        <a
          href={veteranPath}
          aria-label={isSpanish ? "Veterano" : "Veteran"}
          aria-current={currentPageType === 'veteran' ? 'page' : undefined}
          class={`page-link nav-link px-2 sm:px-3 md:px-4 lg:px-6 py-2 md:py-3 font-semibold text-xs sm:text-sm md:text-base transition-all duration-200 whitespace-nowrap relative min-h-[44px] flex items-center ${
            currentPageType === 'veteran'
              ? 'bg-accent text-white border-b-2 border-white'
              : 'text-white/80 hover:text-white hover:bg-primary-light/20'
          }`}
        >
          {isSpanish ? 'Veterano' : 'Veteran'}
        </a>
        </div>
      </div>
      
      <!-- Right Side: Dark Mode Toggle, Language Toggle and Call Now Button -->
      <div class="flex items-center gap-2 md:gap-3 flex-shrink-0">
        <!-- Dark Mode Toggle -->
        <button
          id="dark-mode-toggle"
          aria-label={isSpanish ? 'Alternar modo oscuro' : 'Toggle dark mode'}
          class="dark-mode-toggle bg-white/10 hover:bg-white/20 text-white p-2 sm:p-2.5 rounded-md transition-all duration-200 border border-white/30 hover:border-white/50 flex items-center justify-center flex-shrink-0 min-w-[44px] min-h-[44px]"
          title={isSpanish ? 'Alternar modo oscuro' : 'Toggle dark mode'}
        >
          <svg id="dark-mode-icon" class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
          <svg id="light-mode-icon" class="w-4 h-4 sm:w-5 sm:h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </button>
        <!-- Language Toggle -->
        <a 
          href={alternateLanguageUrl}
          aria-label={isSpanish ? 'Switch to English' : 'Cambiar a Español'}
          class="language-toggle bg-white/10 hover:bg-white/20 text-white px-2 sm:px-3 md:px-4 lg:px-5 py-2 md:py-2.5 rounded-md font-semibold text-xs sm:text-sm md:text-base whitespace-nowrap transition-all duration-200 border border-white/30 hover:border-white/50 flex items-center gap-1 sm:gap-2 flex-shrink-0 hover:scale-105 active:scale-95 min-h-[44px]"
          title={isSpanish ? 'Switch to English' : 'Cambiar a Español'}
          data-target-lang={isSpanish ? 'en' : 'es'}
        >
          <svg class="w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0 transition-transform duration-200 group-hover:rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 002 2h2.945M15 11a3 3 0 11-6 0m6 0a3 3 0 10-6 0m6 0H9m3 0v1m0-1v-1m0 1H9m3 0h3M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {alternateLanguageLabel}
        </a>
        <!-- Call Now Button -->
        <a 
          href={`tel:${formatPhoneTel(siteDetails.phone)}`}
          aria-label={isSpanish ? 'Llame ahora' : 'Call now'}
          class="bg-accent hover:bg-accent-dark text-white px-3 sm:px-4 md:px-6 lg:px-8 py-2 md:py-2.5 rounded-md font-semibold text-xs sm:text-sm md:text-base whitespace-nowrap transition-all duration-200 shadow-md hover:shadow-lg flex-shrink-0 hover:scale-105 active:scale-95 flex items-center gap-2 group min-h-[44px]"
          data-lang-en="Call Now"
          data-lang-es="Llame Ahora"
        >
          <svg class="w-4 h-4 flex-shrink-0 transition-transform duration-200 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
          </svg>
          <span class="hidden sm:inline">{callNowButtonText}</span>
          <span class="sm:hidden">{isSpanish ? 'Llamar' : 'Call'}</span>
        </a>
      </div>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-menu"
      class="md:hidden fixed inset-0 top-14 bg-primary/98 backdrop-blur-sm z-40 transform translate-x-full transition-transform duration-300 ease-in-out"
      aria-label={isSpanish ? "Menú de navegación móvil" : "Mobile navigation menu"}
      role="navigation"
    >
      <div class="container mx-auto px-4 py-6">
        <nav class="flex flex-col gap-2" aria-label={isSpanish ? "Navegación principal" : "Main navigation"}>
          <a
            href={generalPath}
            aria-label={isSpanish ? "Inicio" : "Home"}
            aria-current={currentPageType === 'general' ? 'page' : undefined}
            class={`page-link mobile-nav-link px-4 py-4 font-semibold text-lg transition-all duration-200 rounded-md min-h-[44px] flex items-center ${
              currentPageType === 'general'
                ? 'bg-accent text-white'
                : 'text-white/90 hover:text-white hover:bg-primary-light/30'
            }`}
            onclick="document.getElementById('mobile-menu-toggle')?.click();"
          >
            {isSpanish ? 'Inicio' : 'Home'}
          </a>
          <a
            href={catholicPath}
            aria-label={isSpanish ? "Católico" : "Catholic"}
            aria-current={currentPageType === 'catholic' ? 'page' : undefined}
            class={`page-link mobile-nav-link px-4 py-4 font-semibold text-lg transition-all duration-200 rounded-md min-h-[44px] flex items-center ${
              currentPageType === 'catholic'
                ? 'bg-accent text-white'
                : 'text-white/90 hover:text-white hover:bg-primary-light/30'
            }`}
            onclick="document.getElementById('mobile-menu-toggle')?.click();"
          >
            {isSpanish ? 'Católico' : 'Catholic'}
          </a>
          <a
            href={veteranPath}
            aria-label={isSpanish ? "Veterano" : "Veteran"}
            aria-current={currentPageType === 'veteran' ? 'page' : undefined}
            class={`page-link mobile-nav-link px-4 py-4 font-semibold text-lg transition-all duration-200 rounded-md min-h-[44px] flex items-center ${
              currentPageType === 'veteran'
                ? 'bg-accent text-white'
                : 'text-white/90 hover:text-white hover:bg-primary-light/30'
            }`}
            onclick="document.getElementById('mobile-menu-toggle')?.click();"
          >
            {isSpanish ? 'Veterano' : 'Veteran'}
          </a>
        </nav>
      </div>
    </div>
    
    <!-- Mobile Menu Backdrop -->
    <div
      id="mobile-menu-backdrop"
      class="md:hidden fixed inset-0 bg-black/50 z-30 opacity-0 pointer-events-none transition-opacity duration-300"
      onclick="document.getElementById('mobile-menu-toggle')?.click();"
      aria-hidden="true"
    ></div>
  </div>
</nav>

<script>
  // Mobile Menu Toggle Functionality
  (function() {
    try {
      function initMobileMenu() {
        try {
          const menuToggle = document.getElementById('mobile-menu-toggle');
          const mobileMenu = document.getElementById('mobile-menu');
          const menuBackdrop = document.getElementById('mobile-menu-backdrop');
          const hamburgerIcon = document.getElementById('hamburger-icon');
          const closeIcon = document.getElementById('close-icon');
          
          if (!menuToggle || !mobileMenu || !menuBackdrop || !hamburgerIcon || !closeIcon) {
            return;
          }
          
          function openMenu() {
            mobileMenu.classList.remove('translate-x-full');
            menuBackdrop.classList.remove('opacity-0', 'pointer-events-none');
            menuBackdrop.classList.add('opacity-100', 'pointer-events-auto');
            hamburgerIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            menuToggle.setAttribute('aria-expanded', 'true');
            // Prevent body scroll when menu is open
            document.body.style.overflow = 'hidden';
          }
          
          function closeMenu() {
            mobileMenu.classList.add('translate-x-full');
            menuBackdrop.classList.remove('opacity-100', 'pointer-events-auto');
            menuBackdrop.classList.add('opacity-0', 'pointer-events-none');
            hamburgerIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
            menuToggle.setAttribute('aria-expanded', 'false');
            // Restore body scroll
            document.body.style.overflow = '';
          }
          
          function toggleMenu() {
            const isOpen = !mobileMenu.classList.contains('translate-x-full');
            if (isOpen) {
              closeMenu();
            } else {
              openMenu();
            }
          }
          
          // Toggle menu on button click
          menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
          });
          
          // Close menu when clicking backdrop
          menuBackdrop.addEventListener('click', () => {
            closeMenu();
          });
          
          // Close menu on escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !mobileMenu.classList.contains('translate-x-full')) {
              closeMenu();
            }
          });
          
          // Close menu when clicking a mobile nav link (handled by onclick attribute, but also here for safety)
          const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
          mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
              // Small delay to allow navigation
              setTimeout(() => {
                closeMenu();
              }, 100);
            });
          });
          
          // Close menu on window resize if it becomes desktop size
          let resizeTimer;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              if (window.innerWidth >= 768) { // md breakpoint
                closeMenu();
              }
            }, 250);
          });
        } catch (err) {
          // Silently fail - mobile menu is a non-critical enhancement
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileMenu);
      } else {
        initMobileMenu();
      }
    } catch (error) {
      // Silently fail - mobile menu is a non-critical enhancement
    }
  })();
  
  // Language Toggle Override Handler
  // Sets language override when user manually clicks language toggle
  (function() {
    try {
      function initLanguageToggle() {
        try {
          const languageToggle = document.querySelector('.language-toggle');
          
          if (!languageToggle) {
            return;
          }
          
          languageToggle.addEventListener('click', (e) => {
            try {
              const targetLang = languageToggle.getAttribute('data-target-lang');
              
              if (targetLang === 'en' || targetLang === 'es') {
                // Set override flag to prevent automatic redirection
                localStorage.setItem('languageOverride', targetLang);
                // Also update preferred language
                localStorage.setItem('preferredLanguage', targetLang);
                // Mark as visited so auto-detection doesn't run
                localStorage.setItem('hasVisited', 'true');
              }
            } catch (err) {
              // Silently fail - language toggle override is a non-critical enhancement
            }
          });
        } catch (err) {
          // Silently fail
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageToggle);
      } else {
        initLanguageToggle();
      }
    } catch (error) {
      // Silently fail - language toggle override is a non-critical enhancement
    }
  })();
  
  // Language detection and text switching for Call Now button
  // Ensure this runs after DOM is ready to prevent any rendering issues
  (function() {
    try {
      function updateLanguage() {
        try {
          const isSpanish = window.location.pathname.includes('-es') || window.location.pathname === '/es';
          
          if (isSpanish) {
            // Update Call Now button text
            document.querySelectorAll('[data-lang-es]').forEach(el => {
              try {
                const esText = el.getAttribute('data-lang-es');
                if (esText && el.href?.includes('tel:')) {
                  el.textContent = esText;
                }
              } catch (err) {
                // Silently fail for individual element updates
              }
            });
          }
          
          // Explicit safeguard: ensure Call Now button is always visible
          const callNowButton = document.querySelector('a[href^="tel:"]');
          if (callNowButton) {
            callNowButton.classList.remove('hidden');
            callNowButton.style.display = '';
            callNowButton.style.visibility = '';
          }
        } catch (err) {
          // Silently fail - language switching is a non-critical enhancement
        }
      }
      
      // Run immediately if DOM is already loaded, otherwise wait
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateLanguage);
      } else {
        // DOM already loaded, run immediately
        updateLanguage();
      }
      
      // Also run after a short delay to catch any late-rendering issues
      setTimeout(() => {
        try {
          updateLanguage();
        } catch (err) {
          // Silently fail
        }
      }, 100);
    } catch (error) {
      // Silently fail - language switching is a non-critical enhancement
    }
  })();
  
  // Dark Mode Toggle Functionality
  (function() {
    try {
      function initDarkMode() {
        try {
          const darkModeToggle = document.getElementById('dark-mode-toggle');
          const darkModeIcon = document.getElementById('dark-mode-icon');
          const lightModeIcon = document.getElementById('light-mode-icon');
          
          if (!darkModeToggle || !darkModeIcon || !lightModeIcon) {
            return;
          }
          
          // Get saved preference or detect system preference
          function getDarkModePreference(): boolean {
            try {
              const saved = localStorage.getItem('darkMode');
              if (saved !== null) {
                return saved === 'true';
              }
              
              // Detect system preference
              if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return true;
              }
              
              return false;
            } catch (err) {
              return false;
            }
          }
          
          // Apply dark mode
          function applyDarkMode(isDark: boolean): void {
            try {
              if (isDark) {
                document.documentElement.classList.add('dark');
                darkModeIcon.classList.add('hidden');
                lightModeIcon.classList.remove('hidden');
                localStorage.setItem('darkMode', 'true');
              } else {
                document.documentElement.classList.remove('dark');
                darkModeIcon.classList.remove('hidden');
                lightModeIcon.classList.add('hidden');
                localStorage.setItem('darkMode', 'false');
              }
            } catch (err) {
              // Silently fail
            }
          }
          
          // Initialize dark mode on page load
          const isDark = getDarkModePreference();
          applyDarkMode(isDark);
          
          // Toggle dark mode on button click
          darkModeToggle.addEventListener('click', () => {
            try {
              const isCurrentlyDark = document.documentElement.classList.contains('dark');
              applyDarkMode(!isCurrentlyDark);
            } catch (err) {
              // Silently fail
            }
          });
          
          // Listen for system preference changes
          if (window.matchMedia) {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', (e) => {
              try {
                // Only auto-switch if user hasn't manually set a preference
                const saved = localStorage.getItem('darkMode');
                if (saved === null) {
                  applyDarkMode(e.matches);
                }
              } catch (err) {
                // Silently fail
              }
            });
          }
        } catch (err) {
          // Silently fail - dark mode is a non-critical enhancement
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDarkMode);
      } else {
        initDarkMode();
      }
    } catch (error) {
      // Silently fail - dark mode is a non-critical enhancement
    }
  })();
</script>

